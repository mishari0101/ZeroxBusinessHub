<div class="dashboard-layout">

  <!-- HAMBURGER BUTTON (Mobile Only) -->
  <button class="hamburger-btn" (click)="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>

  <!-- SIDEBAR -->
  <aside class="sidebar" [class.open]="isSidebarOpen">
    <div class="sidebar-header">
      <h2>Zerox<span>Hub</span></h2>
      <button class="close-btn" (click)="toggleSidebar()"><i class="bi bi-x-lg"></i></button>
    </div>

    <nav class="nav-links">
      <a [class.active]="activeTab === 'analytics'" (click)="switchTab('analytics')"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
      <a [class.active]="activeTab === 'services'" (click)="switchTab('services')"><i class="bi bi-box-seam-fill"></i> My Services</a>
      <a [class.active]="activeTab === 'add'" (click)="initAddService()"><i class="bi bi-plus-square-fill"></i> Add Service</a>
      <a [class.active]="activeTab === 'notifications'" (click)="switchTab('notifications')">
        <i class="bi bi-bell-fill"></i> Requests
        <span class="badge" *ngIf="stats.pending > 0">{{ stats.pending }}</span>
      </a>
      <a [class.active]="activeTab === 'profile'" (click)="switchTab('profile')"><i class="bi bi-person-circle"></i> Profile</a>
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn-animated" (click)="logout()">
        <i class="bi bi-box-arrow-left"></i> <span>Logout</span>
      </button>
    </div>
  </aside>

  <div class="overlay" *ngIf="isSidebarOpen" (click)="toggleSidebar()"></div>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    
    <div class="top-header">
      <div>
        <h1>{{ activeTab === 'analytics' ? 'Dashboard Overview' : (activeTab | titlecase) }}</h1>
        <p class="text-muted">Hello, {{ profile.businessName || 'Partner' }} ðŸ‘‹</p>
      </div>
      <img [src]="selectedProfilePreview || 'assets/img/placeholder-profile.jpg'" class="avatar">
    </div>

    <!-- 1. ANALYTICS -->
    <div *ngIf="activeTab === 'analytics'" class="fade-in">
      <div class="stats-row">
        <div class="stat-card earnings">
          <i class="bi bi-cash-stack"></i>
          <div>
            <h3>${{ stats.earnings }}</h3>
            <p>Net Cash Collected</p>
          </div>
        </div>

        <div class="stat-card wallet clickable" (click)="openWalletModal()" 
             [class.negative]="stats.walletBalance < 20">
          <i class="bi bi-wallet2"></i>
          <div>
            <h3>${{ stats.walletBalance }}</h3>
            <p>Commission Wallet</p>
            <small *ngIf="stats.walletBalance < 20" style="color: #ef4444; font-weight: bold;">Low Balance! Top Up</small>
            <small *ngIf="stats.walletBalance >= 20" style="color: #2ecc71;">+ Top Up</small>
          </div>
        </div>

        <div class="stat-card bookings">
          <i class="bi bi-calendar-check-fill"></i>
          <div><h3>{{ stats.bookings }}</h3><p>Jobs Done</p></div>
        </div>
      </div>
    </div>

    <!-- 2. SERVICES -->
    <div *ngIf="activeTab === 'services'" class="fade-in">
      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-primary" (click)="initAddService()">+ Add New</button>
      </div>
      <div class="services-grid">
        <div class="service-card" *ngFor="let service of services">
          <div class="img-box" [style.backgroundImage]="'url(' + service.imageUrl + ')'"></div>
          <div class="info-box">
            <h5 class="text-truncate">{{ service.serviceName }}</h5>
            <p class="price">${{ service.price }}</p>
            <div class="actions">
                <button class="btn-stylish edit" (click)="initEditService(service)"><i class="bi bi-pencil-fill"></i> Edit</button>
                <button class="btn-stylish delete" (click)="deleteService(service.id)"><i class="bi bi-trash-fill"></i> Delete</button>
            </div>
          </div>
        </div>
        <div *ngIf="services.length === 0" class="col-12 text-center text-muted p-5">
            <p>No services found. Click "Add New" to start.</p>
        </div>
      </div>
    </div>

    <!-- 3. ADD / EDIT SERVICE -->
    <div *ngIf="activeTab === 'add'" class="fade-in">
        <div class="form-card">
            <h3>{{ isEditMode ? 'Edit Service' : 'Add New Service' }}</h3>
            <div class="upload-box" (click)="fileInput.click()"
                [style.backgroundImage]="selectedImagePreview ? 'url(' + selectedImagePreview + ')' : 'none'">
                <span *ngIf="!selectedImagePreview">+ Upload Image</span>
            </div>
            <input type="file" #fileInput (change)="onFileSelected($event)" hidden accept="image/*">
            <div class="form-group mb-3"><label>Service Name</label><input class="form-control" [(ngModel)]="newService.serviceName"></div>
            <div class="row mb-3">
                <div class="col-6"><label>Price ($)</label><input type="number" class="form-control" [(ngModel)]="newService.price"></div>
                <div class="col-6"><label>Duration (Mins)</label><input type="number" class="form-control" [(ngModel)]="newService.durationMinutes"></div>
            </div>
            <div class="form-group mb-3"><label>Description</label><textarea class="form-control" rows="3" [(ngModel)]="newService.description"></textarea></div>
            <button class="btn btn-primary w-100" (click)="saveService()">{{ isLoading ? 'Saving...' : 'Save Service' }}</button>
        </div>
    </div>

    <!-- REQUESTS TAB -->
<div *ngIf="activeTab === 'notifications'" class="fade-in">
  <h3>Order History</h3>
  <div class="request-list">
    
    <div class="request-card" *ngFor="let notif of notifications" [ngClass]="notif.status.toLowerCase()">
      
      <!-- LEFT SIDE: INFO -->
      <div class="req-info">
        <h5 class="mb-1 fw-bold">{{ notif.customerName }}</h5>
        
        <p class="service-title">Requested: <strong class="text-primary">{{ notif.serviceName }}</strong></p>
        <span class="price-tag-small">${{ notif.price }}</span>

        <div class="booking-details mt-2">
            <p><i class="bi bi-calendar-event text-warning"></i> {{ notif.bookingTimeSlot | date:'medium' }}</p>
            <p><i class="bi bi-geo-alt-fill text-danger"></i> {{ notif.customerLocation }}</p>
            <p class="mt-1">
                <span class="payment-badge" 
                      [class.online]="notif.paymentMethod === 'Online'"
                      [class.cash]="notif.paymentMethod === 'Cash'">
                    {{ notif.paymentMethod || 'Cash' }}
                </span>
            </p>
        </div>
      </div>

      <!-- RIGHT SIDE: ACTIONS COLUMN -->
      <div class="req-actions-col">
        
        <!-- GROUP 1: STATUS & TEXT -->
        <div class="status-group">
          <!-- Status Badge -->
          <span class="status-pill" [ngClass]="notif.status.toLowerCase()">
            {{ notif.status }}
          </span>

          <!-- Order Finished Text -->
          <span *ngIf="notif.status === 'Accepted' || notif.status === 'Completed'" 
                class="finished-text text-success">
            <i class="bi bi-check-circle-fill"></i> Order Finished
          </span>
          
           <!-- Declined Text -->
           <span *ngIf="notif.status === 'Declined'" class="finished-text text-muted">
            Request Declined
          </span>
        </div>

        <!-- GROUP 2: BUTTONS -->
        <div class="buttons-group">
          
          <!-- PENDING BUTTONS -->
          <div *ngIf="notif.status === 'Pending'" class="d-flex flex-column gap-2 w-100">
            <button class="btn-accept w-100" (click)="initAcceptBooking(notif)">Accept</button>
            <button class="btn-decline w-100" (click)="initDeclineBooking(notif)">Decline</button>
          </div>

          <!-- CHAT BUTTON (Only if Accepted/Completed) -->
          <button *ngIf="notif.status === 'Accepted' || notif.status === 'Completed'" 
                  class="btn-chat" (click)="goToChat(notif.id)" title="Chat with Customer">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 16 16">
              <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
            </svg>
          </button>

        </div>

      </div>

    </div>

    <!-- Empty State -->
    <div *ngIf="notifications.length === 0" class="text-muted p-4 text-center border rounded bg-white">
      No orders found.
    </div>
  </div>
</div>

    <!-- 5. PROFILE -->
    <div *ngIf="activeTab === 'profile'" class="fade-in">
        <div class="form-card profile-section">
            <div class="profile-header-row">
                <h3 class="mb-0">Profile Details</h3>
                <button class="edit-icon-btn" (click)="toggleProfileEdit()" *ngIf="!isEditingProfile" title="Edit Profile">
                    âœŽ
                </button>
            </div>
            <div class="profile-pic-wrapper mb-4">
                <div class="pic-container" [class.editable]="isEditingProfile" (click)="isEditingProfile && profileInput.click()">
                    <img [src]="selectedProfilePreview" alt="Profile">
                    <div class="overlay" *ngIf="isEditingProfile"><i class="bi bi-camera-fill"></i></div>
                </div>
                <input type="file" #profileInput (change)="onProfilePicSelected($event)" hidden accept="image/*">
            </div>
            <div class="profile-form" [class.editing]="isEditingProfile">
                <div class="mb-3"><label>Business Name</label><input class="form-control profile-input" [(ngModel)]="profile.businessName" [disabled]="!isEditingProfile"></div>
                <div class="mb-3"><label>Address</label><input class="form-control profile-input" [(ngModel)]="profile.address" [disabled]="!isEditingProfile"></div>
                <div class="row mb-3">
                    <div class="col-6"><label>District</label><input class="form-control profile-input" [(ngModel)]="profile.district" [disabled]="!isEditingProfile"></div>
                    <div class="col-6"><label>Phone</label><input class="form-control profile-input" [(ngModel)]="profile.phone" [disabled]="!isEditingProfile"></div>
                </div>
                <div class="profile-actions" *ngIf="isEditingProfile">
                    <button class="btn-cancel" (click)="cancelProfileEdit()">Cancel</button>
                    <button class="btn-save-profile" (click)="saveProfile()"><span *ngIf="!isLoading"><i class="bi bi-check-circle-fill"></i> Save Changes</span><span *ngIf="isLoading">Saving...</span></button>
                </div>
            </div>
        </div>
    </div>

  </main>
</div>

<!-- ============================================== -->
<!-- ðŸ”¥ CUSTOM MODALS -->
<!-- ============================================== -->

<!-- Success -->
<div class="custom-modal-overlay" *ngIf="showSuccessModal">
  <div class="custom-modal">
    <div class="icon-circle success">âœ“</div>
    <h3>Success!</h3>
    <p>{{ modalMessage }}</p>
    <button class="btn-modal success" (click)="closeModals()">Awesome</button>
  </div>
</div>

<!-- Confirm -->
<div class="custom-modal-overlay" *ngIf="showConfirmModal">
  <div class="custom-modal">
    <div class="icon-circle confirm">?</div>
    <h3>{{ confirmTitle }}</h3>
    <div class="modal-content-scroll">
      <p [innerHTML]="confirmMessage"></p>
    </div>
    <div class="modal-actions">
      <button class="btn-modal cancel" (click)="closeModals()">Cancel</button>
      <button class="btn-modal confirm" (click)="onConfirmAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- Error -->
<div class="custom-modal-overlay" *ngIf="showErrorModal">
  <div class="custom-modal">
    <div class="icon-circle error">!</div>
    <h3>Attention</h3>
    <div class="modal-content-scroll">
      <p [innerHTML]="errorMessage"></p>
    </div>
    <div class="modal-actions">
      <button class="btn-modal cancel" (click)="closeModals()">Close</button>
      <button class="btn-modal error" (click)="closeModals(); openWalletModal()">Top Up Now</button>
    </div>
  </div>
</div>

<!-- Wallet -->
<div class="modal-overlay" *ngIf="showWalletModal">
  <div class="modal-card">
    <div class="modal-header">
      <h4>Top Up Wallet</h4>
      <button class="close-btn" (click)="closeWalletModal()">âœ•</button>
    </div>
    <div class="modal-body text-center">
      <p class="text-muted mb-4">Add money to your commission wallet to accept more bookings.</p>
      <div class="amount-input-wrapper mb-4">
        <span class="currency">$</span>
        <input type="number" [(ngModel)]="topUpAmount" class="amount-input" placeholder="0">
      </div>
      <div class="quick-amounts mb-4">
        <button class="btn btn-outline-secondary btn-sm" (click)="topUpAmount = 50">$50</button>
        <button class="btn btn-outline-secondary btn-sm" (click)="topUpAmount = 100">$100</button>
        <button class="btn btn-outline-secondary btn-sm" (click)="topUpAmount = 500">$500</button>
      </div>
      <button class="btn btn-primary w-100 py-2" (click)="confirmTopUp()">Pay & Top Up</button>
    </div>
  </div>
</div>